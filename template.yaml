AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: ffxiv party finder notifier (EventBridge -> Lambda -> Discord webhook)

Parameters:
  DiscordWebhookUrl:
    Type: String
    NoEcho: true
    Description: Discord Webhook URL
  Limit:
    Type: Number
    Default: 5
    Description: "Max messages per run (FFXIV_PTFINDER_LIMIT)"
  FilterFile:
    Type: String
    Default: "data/filter.json"
    Description: "Path to JSON filter file in the deployment package (FFXIV_PTFINDER_FILTER_FILE)"

Resources:
  PtfinderFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ffxiv-ptfinder-notifier
      Runtime: nodejs20.x
      Architectures:
        - arm64
      Handler: dist/lambdaHandler.handler
      CodeUri: .
      MemorySize: 512
      Timeout: 120
      Environment:
        Variables:
          DISCORD_WEBHOOK_URL: !Ref DiscordWebhookUrl
          FFXIV_PTFINDER_LIMIT: !Ref Limit
          FFXIV_PTFINDER_FILTER_FILE: !Ref FilterFile
      Events:
        Schedule30m:
          Type: Schedule
          Properties:
            # JST 18:00-23:30 (UTC 09:00-14:30) のみ30分間隔で実行
            Schedule: cron(0/30 9-14 ? * * *)
            Enabled: true
    Metadata:
      BuildMethod: makefile

Outputs:
  FunctionName:
    Value: !Ref PtfinderFunction
  FunctionArn:
    Value: !GetAtt PtfinderFunction.Arn
